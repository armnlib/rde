#!/bin/ksh
DESC='Find the list of targets in the specified file (Makefile)'
USAGE="USAGE: ${0##*/} [--nodep] [--norules] File"
usage_long() {
	 toto=$(echo -e $USAGE)
	 more <<EOF
$DESC

$toto
EOF
}

nodep=0
norules=0
filelist=""
while [[ $# -gt 0 ]] ; do
   case $1 in
      (-h|--help) usage_long; exit 0;;
      (--nodep) nodep=1;;
      (--norules) norules=1;;
      (-*) echo "ERROR: Bad options: $1"; usage_long; exit 0;;
        *) filelist="$filelist $1";;
    esac
	 previous=$1
    shift
done

if [[ -x $filelist ]] ; then
   echo "ERROR: Must provide at least one file"
   usage_long
   exit 1
fi

for item in $filelist ; do
   if [[ $norules == 1 && x"${item##*/}" == x"Makefile.rules.mk" ]] ; then
      a=1
      #echo ignoring ${item##*/}
   else
      #echo Parsing ${item} : ${item##*/}
      if [[ $nodep == 1 ]] ; then
         grep [a-zA-Z0-9]: ${item} | grep -v PHONY | grep -v .DEFAULT | grep -v '\.o:' | grep -v '\.f90:' | grep -v '\.c:' | grep -v '_invdep_' | cut -d: -f1 | grep -v \# | grep -v \( | grep -v \"
      else
         grep [a-zA-Z0-9]: ${item} | grep -v PHONY | grep -v .DEFAULT | cut -d: -f1 | grep -v \# | grep -v \( | grep -v \"
      fi
   fi
done
