#!/bin/ksh
# @Object: Checkout library version of a source file
# @Author: S.Chamberland
# @Date:   March 2014
. .pfbase.inc.dot

DESC='Checkout library version of a source file'
USAGE="USAGE: ${MYSELF} [-h] [-v] [-f] FILES"

usage_long() {
	 toto=$(echo -e $USAGE)
	 more <<EOF
$DESC

$toto

Options:
    -h, --help         : print this help
    -v, --verbose      : verbose mode
    -f, --force        : 
    FILES              : space separated list of src files or dir

EOF
}

mystatus=0
myforce=0
while [[ $# -gt 0 ]] ; do
   case $1 in
      (-h|--help) usage_long; exit 0;;
      (-v|--verbose) ((verbose++));;
      (-f|--force) myforce=1;;
      (--) shift ; break;;
      (-*) myerror "Option Not recognized: $1";;
        *) PATHLIST="$PATHLIST $1";;
    esac
	 previous=$1
    shift
done
PATHLIST="$PATHLIST $@"

pf_exit_if_not_pftopdir

for myfile in $PATHLIST ; do
   mypathlist="$(find_src ${SRC_REF} $myfile)"
   if [[ x${mypathlist} == x ]] ; then
      cat <<EOF
    ERROR: File $myfile is not found in ${SRC_REF}/
EOF
      mystatus=0
   else
      for mypath in ${mypathlist} ; do
         isdir=0
         replaced=""
         #mypath=${mypath#*/}
         if [[ -e ${ROOT}/${SRC_USR}/$mypath ]] ; then
            if [[ $myforce == 0 ]] ; then
            cat 1>&2 <<EOF
    WARNING: File $mypath already exists, overwrite with: 
             ${MYSELF} -f $myfile
EOF
               mypath=""
            else
               if [[ -d ${ROOT}/${SRC_USR}/$mypath ]] ; then
                  isdir=1
                  rm -rf ${ROOT}/${SRC_USR}/$mypath
                  replaced="(overwritting existing dir)"
              else
                  rm -f ${ROOT}/${SRC_USR}/$mypath
                  replaced="(overwritting existing file)"
               fi
            fi
         fi

         if [[ x$mypath != x ]] ; then
            rm -f ${ROOT}/${SRC_USR}/$(echo_deleted_tag ${mypath}) 2> /dev/null || true
            if [[ $isdir == 1 ]] ; then
               rsync -a ${ROOT}/${SRC_REF}/$mypath/ ${ROOT}/${SRC_USR}/$mypath
            else
               rsync -a ${ROOT}/${SRC_REF}/$mypath ${ROOT}/${SRC_USR}/$mypath
            fi
            chmod -R u+w ${ROOT}/${SRC_USR}/$mypath
            if [[ x${replaced} != x ]] ; then
               touch ${ROOT}/${SRC_USR}/$mypath
            fi
            cat <<EOF
    Checking out ${mypath} ${replaced}
EOF
         fi
      done
   fi
done

if [[ -f .pf.flatsrc ]] ; then
   pflinkflat
fi

exit $mystatus
